<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
	<title></title>
</head>
<body>
	<canvas id="DaCanvas" width="100" height="100"></canvas>
	<div><label>原始</label><input id="ori" type="color" /></div>
	<div><label>替换</label><input id="rep" type="color" /></div>
	<script>


		let frame = {
			width: 564 / 9,
			height: 774 / 8,
		};

		let curFrame = {
			x: 0,
			y: 0,
		};

		let delay = 50;
		let nextKey = delay;


		let oriCol = document.querySelector('#ori');
		let repCol = document.querySelector('#rep');
		

		let backBuffer = document.createElement('canvas');
		backBuffer.width = 100;
		backBuffer.height = 100;
		let bbCtx = backBuffer.getContext('2d');

		let img = new Image();
		img.onload = () => {
			let canvas = document.querySelector('#DaCanvas');
			let ctx = canvas.getContext('2d');

			function draw(t) {
				if (t >= nextKey) {
					nextKey += delay;

					curFrame.x += frame.width;
					if (curFrame.x > img.width) {
						curFrame.x = 0;
						curFrame.y += frame.height;
						if (curFrame.y > img.height) {
							curFrame.y = 0;
						}
					}
				}

				bbCtx.drawImage(img, curFrame.x, curFrame.y, frame.width, frame.height, 0, 0, frame.width, frame.height);

				let imgData = bbCtx.getImageData(0, 0, 100, 100);
				let ori = oriCol.value;
				let oriR = parseInt(ori.slice(1, 3), 16);
				let oriG = parseInt(ori.slice(3, 5), 16);
				let oriB = parseInt(ori.slice(5, 7), 16);
				
				let rep = repCol.value;
				let repR = parseInt(rep.slice(1, 3), 16);
				let repG = parseInt(rep.slice(3, 5), 16);
				let repB = parseInt(rep.slice(5, 7), 16);

				for (var i = 0; i < 10000; i++) {
					// imgData.data[Math.floor(Math.random() * 100 * 100 * 4)] = 0;

					if (Math.abs(oriR - imgData.data[4 * i]) < 32
							&& Math.abs(oriG - imgData.data[4 * i + 1]) < 32
							&& Math.abs(oriB - imgData.data[4 * i] + 2) < 32) {

						imgData.data[4 * i] = repR;
						imgData.data[4 * i + 1] = repG;
						imgData.data[4 * i + 2] = repB;
					}
				}
				bbCtx.putImageData(imgData, 0, 0);

				ctx.drawImage(backBuffer, 0, 0);
				
				window.requestAnimationFrame(draw);
			}

			window.requestAnimationFrame(draw);

		};
		img.src = '132545930dbc308961.jpg';

	</script>	
</body>
</html>